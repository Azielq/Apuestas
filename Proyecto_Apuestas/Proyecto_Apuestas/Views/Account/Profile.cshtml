@model Proyecto_Apuestas.ViewModels.UserProfileViewModel
@{
    ViewData["Title"] = "Mi Perfil";
}

<div class="container my-4">
    <div class="row">
        <div class="col-md-8">
            <div class="card hover-lift transition-normal">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4><i class="bi bi-person me-2 text-primary"></i>Información del Perfil</h4>
                    <button class="btn btn-outline-primary btn-sm hover-scale" data-bs-toggle="modal" data-bs-target="#editProfileModal">
                        <i class="bi bi-pencil me-1"></i>Editar Perfil
                    </button>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <strong class="text-primary">Nombre de Usuario:</strong>
                            <p class="mb-1">@Model.UserName</p>
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong class="text-primary">Email:</strong>
                            <p class="mb-1">@Model.Email</p>
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong class="text-primary">Nombre Completo:</strong>
                            <p class="mb-1">@Model.FullName</p>
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong class="text-primary">Teléfono:</strong>
                            <p class="mb-1">@(Model.PhoneNumber ?? "No registrado")</p>
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong class="text-primary">País:</strong>
                            <p class="mb-1">@(Model.Country ?? "No registrado")</p>
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong class="text-primary">Fecha de Registro:</strong>
                            <p class="mb-1">@Model.CreatedAt.ToString("dd/MM/yyyy")</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card mb-3 hover-lift transition-normal shadow-primary">
                <div class="card-header text-center">
                    <h5><i class="bi bi-wallet2 me-2 text-success"></i>Balance</h5>
                </div>
                <div class="card-body text-center">
                    <h3 class="text-success mb-3">@Model.CreditBalance.ToString("C")</h3>
                    <div class="d-flex gap-2 justify-content-center">
                        <a asp-controller="Payment" asp-action="Deposit" class="btn btn-success btn-sm hover-scale">
                            <i class="bi bi-plus-circle me-1"></i>Depositar
                        </a>
                        <a asp-controller="Payment" asp-action="Withdraw" class="btn btn-outline-secondary btn-sm hover-scale">
                            <i class="bi bi-dash-circle me-1"></i>Retirar
                        </a>
                    </div>
                </div>
            </div>

            <div class="card hover-lift transition-normal">
                <div class="card-header text-center">
                    <h5><i class="bi bi-bar-chart me-2 text-info"></i>Estadísticas</h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-12 mb-3">
                            <small class="text-muted">Total Apuestas</small>
                            <div class="fw-bold fs-4 text-primary">@Model.TotalBets</div>
                        </div>
                        <div class="col-4">
                            <small class="text-success">Ganadas</small>
                            <div class="fw-bold text-success">@Model.WonBets</div>
                        </div>
                        <div class="col-4">
                            <small class="text-danger">Perdidas</small>
                            <div class="fw-bold text-danger">@Model.LostBets</div>
                        </div>
                        <div class="col-4">
                            <small class="text-warning">Pendientes</small>
                            <div class="fw-bold text-warning">@Model.PendingBets</div>
                        </div>
                    </div>
                    @if (Model.TotalBets > 0)
                    {
                        <hr class="border-primary">
                        <div class="text-center">
                            <small class="text-muted">Tasa de Éxito</small>
                            <div class="fw-bold text-success fs-5">@Model.WinRate.ToString("P1")</div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-12">
            <div class="card hover-lift transition-normal">
                <div class="card-header">
                    <h5><i class="bi bi-gear me-2 text-warning"></i>Configuración de Cuenta</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-2">
                            <button class="btn btn-outline-warning w-100 hover-scale" data-bs-toggle="modal" data-bs-target="#changePasswordModal">
                                <i class="bi bi-key me-1"></i>Cambiar Contraseña
                            </button>
                        </div>
                        <div class="col-md-6 mb-2">
                            <a asp-controller="Betting" asp-action="Index" class="btn btn-outline-info w-100 hover-scale">
                                <i class="bi bi-clock-history me-1"></i>Historial de Apuestas
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- EDIT PROFILE MODAL -->
<div class="modal fade" id="editProfileModal" tabindex="-1" aria-labelledby="editProfileModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content bg-dark text-white">
            <div class="modal-header border-bottom border-primary">
                <h5 class="modal-title" id="editProfileModalLabel">
                    <i class="bi bi-person-gear me-2 text-primary"></i>Editar Perfil
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <form id="editProfileForm" method="post" action="/Account/EditProfile" novalidate>
                    @Html.AntiForgeryToken()

                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="EditFirstName" class="form-label">
                                <i class="bi bi-person me-1"></i>Nombre
                            </label>
                            <input type="text" class="form-control" id="EditFirstName" name="FirstName" 
                                   value="@Model.FirstName" placeholder="Ej: Juan" required />
                            <div class="invalid-feedback">El nombre es requerido.</div>
                        </div>

                        <div class="col-md-6">
                            <label for="EditPrimerApellido" class="form-label">
                                <i class="bi bi-person-badge me-1"></i>Primer Apellido
                            </label>
                            <input type="text" class="form-control" id="EditPrimerApellido" name="PrimerApellido" 
                                   value="@Model.PrimerApellido" placeholder="Ej: Castillo" required />
                            <div class="invalid-feedback">El primer apellido es requerido.</div>
                        </div>

                        <div class="col-md-6">
                            <label for="EditSegundoApellido" class="form-label">
                                <i class="bi bi-person-lines-fill me-1"></i>Segundo Apellido
                            </label>
                            <input type="text" class="form-control" id="EditSegundoApellido" name="SegundoApellido" 
                                   value="@Model.SegundoApellido" placeholder="Ej: López" />
                        </div>

                        <div class="col-md-6">
                            <label for="EditPhoneNumber" class="form-label">
                                <i class="bi bi-telephone me-1"></i>Teléfono
                            </label>
                            <input type="tel" class="form-control" id="EditPhoneNumber" name="PhoneNumber" 
                                   value="@Model.PhoneNumber" placeholder="Ej: +506 8888-8888 o 8888-8888" 
                                   pattern="^(\+506\s?)?[2678]\d{3}[\-\s]?\d{4}$" 
                                   title="Formato válido: +506 8888-8888, 8888-8888, +506 2222-2222 o 2222-2222" />
                            <div class="invalid-feedback">Formato de teléfono inválido. Use: +506 8888-8888, 8888-8888, +506 2222-2222 o 2222-2222</div>
                        </div>

                        <div class="col-12">
                            <label for="EditCountry" class="form-label">
                                <i class="bi bi-geo-alt me-1"></i>País
                            </label>
                            <select class="form-control" id="EditCountry" name="Country" required>
                                <option value="">Selecciona tu país</option>
                                @{
                                    var countries = new[] { "Costa Rica", "Guatemala", "Honduras", "El Salvador", "Nicaragua", "Panamá" };
                                }
                                @foreach (var country in countries)
                                {
                                    if (Model.Country == country)
                                    {
                                        <option value="@country" selected>@country</option>
                                    }
                                    else
                                    {
                                        <option value="@country">@country</option>
                                    }
                                }
                            </select>
                            <div class="invalid-feedback">Selecciona un país.</div>
                        </div>
                    </div>

                    <div id="editProfileError" class="alert alert-danger visually-hidden mt-3" role="alert"></div>
                    <div id="editProfileSuccess" class="alert alert-success visually-hidden mt-3" role="alert"></div>
                    
                    <div class="mt-4 d-flex gap-2">
                        <button type="submit" class="btn btn-primary hover-scale">
                            <i class="bi bi-check-circle me-1"></i>Guardar Cambios
                        </button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="bi bi-x-circle me-1"></i>Cancelar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- CHANGE PASSWORD MODAL -->
<div class="modal fade" id="changePasswordModal" tabindex="-1" aria-labelledby="changePasswordModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark text-white">
            <div class="modal-header border-bottom border-warning">
                <h5 class="modal-title" id="changePasswordModalLabel">
                    <i class="bi bi-key me-2 text-warning"></i>Cambiar Contraseña
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <form id="changePasswordForm" method="post" action="/Account/ChangePassword" novalidate>
                    @Html.AntiForgeryToken()

                    <div class="mb-3">
                        <label for="CurrentPassword" class="form-label">
                            <i class="bi bi-lock-fill me-1"></i>Contraseña Actual
                        </label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="CurrentPassword" name="CurrentPassword" 
                                   placeholder="Ingresa tu contraseña actual" required />
                            <button class="btn btn-outline-secondary" type="button" id="toggleCurrentPassword" aria-label="Mostrar contraseña">
                                <i class="bi bi-eye" id="toggleCurrentPasswordIcon"></i>
                            </button>
                        </div>
                        <div class="invalid-feedback">La contraseña actual es requerida.</div>
                    </div>

                    <div class="mb-3">
                        <label for="NewPassword" class="form-label">
                            <i class="bi bi-shield-lock me-1"></i>Nueva Contraseña
                        </label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="NewPassword" name="NewPassword" 
                                   placeholder="Mínimo 8 caracteres" minlength="8" required />
                            <button class="btn btn-outline-secondary" type="button" id="toggleNewPassword" aria-label="Mostrar contraseña">
                                <i class="bi bi-eye" id="toggleNewPasswordIcon"></i>
                            </button>
                        </div>
                        <div class="invalid-feedback">La nueva contraseña debe tener al menos 8 caracteres.</div>
                        
                        <!-- Password Strength Indicator -->
                        <div class="password-strength mt-2" id="passwordStrengthModal" style="display: none;">
                            <div class="progress" style="height: 5px;">
                                <div class="progress-bar" role="progressbar" style="width: 0%" id="strengthBarModal"></div>
                            </div>
                            <small class="text-muted" id="strengthTextModal">Fortaleza de la contraseña</small>
                        </div>
                        
                        <!-- Password Requirements -->
                        <div class="password-requirements mt-2" id="passwordRequirementsModal" style="display: none;">
                            <small class="text-muted d-block">La contraseña debe contener:</small>
                            <small class="requirement d-block" id="req-length-modal"><i class="bi bi-x-circle text-danger me-1"></i>Al menos 8 caracteres</small>
                            <small class="requirement d-block" id="req-uppercase-modal"><i class="bi bi-x-circle text-danger me-1"></i>Una letra mayúscula</small>
                            <small class="requirement d-block" id="req-lowercase-modal"><i class="bi bi-x-circle text-danger me-1"></i>Una letra minúscula</small>
                            <small class="requirement d-block" id="req-number-modal"><i class="bi bi-x-circle text-danger me-1"></i>Un número</small>
                            <small class="requirement d-block" id="req-special-modal"><i class="bi bi-x-circle text-danger me-1"></i>Un carácter especial</small>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="ConfirmPassword" class="form-label">
                            <i class="bi bi-shield-check me-1"></i>Confirmar Nueva Contraseña
                        </label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="ConfirmPassword" name="ConfirmPassword" 
                                   placeholder="Repite la nueva contraseña" required />
                            <button class="btn btn-outline-secondary" type="button" id="toggleConfirmPasswordModal" aria-label="Mostrar contraseña">
                                <i class="bi bi-eye" id="toggleConfirmPasswordModalIcon"></i>
                            </button>
                        </div>
                        <div class="invalid-feedback">Confirma tu nueva contraseña.</div>
                        
                        <!-- Password Match Indicator -->
                        <div class="password-match mt-2" id="passwordMatchModal" style="display: none;">
                            <small class="text-muted" id="matchTextModal">Las contraseñas deben coincidir</small>
                        </div>
                    </div>

                    <div id="changePasswordError" class="alert alert-danger visually-hidden" role="alert"></div>
                    <div id="changePasswordSuccess" class="alert alert-success visually-hidden" role="alert"></div>
                    
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-warning w-100 hover-scale">
                            <i class="bi bi-key me-1"></i>Cambiar Contraseña
                        </button>
                    </div>
                </form>
                
                <div class="text-center mt-3">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-1"></i>Cancelar
                    </button>
                </div>
                
                <div class="mt-3">
                    <small class="text-muted">
                        <i class="bi bi-info-circle me-1"></i>
                        Asegúrate de recordar tu nueva contraseña. Te recomendamos usar una combinación de letras, números y símbolos.
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>
